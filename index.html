<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือจัดการธุรกิจ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8;
        }
        .pastel-bg-blue { background-color: #e0f7fa; }
        .pastel-bg-green { background-color: #e8f5e9; }
        .pastel-bg-pink { background-color: #fce4ec; }
        .pastel-bg-purple { background-color: #f3e5f5; }
        .pastel-bg-yellow { background-color: #fffde7; }

        .btn {
            @apply px-6 py-3 rounded-lg shadow-md font-bold text-lg text-gray-700 transition-transform transform hover:scale-105;
        }

        .page {
            display: none;
        }

        .active-page {
            display: block;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area .no-print {
                visibility: hidden;
                display: none;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <div id="app-container" class="max-w-7xl mx-auto p-4 md:p-8 hidden">
        <!-- Header -->
        <header class="text-center mb-8 relative">
            <div id="auth-container" class="absolute top-0 right-0">
                 <!-- Login/Logout Button will appear here -->
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-gray-700">ระบบจัดการธุรกิจ</h1>
            <p class="text-lg text-gray-500 mt-2">สร้างและจัดการเอกสารธุรกิจของคุณได้อย่างง่ายดาย</p>
            <p id="user-info" class="text-sm text-gray-500 mt-2 hidden">
                <span id="user-display-name"></span> (<span id="user-email"></span>)
            </p>
        </header>

        <!-- Main Navigation -->
        <nav id="main-nav" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <button onclick="showPage('dashboard')" class="btn pastel-bg-blue"><i class="fas fa-home mr-2"></i>หน้าหลัก</button>
            <button onclick="showPage('inventory')" class="btn pastel-bg-green"><i class="fas fa-warehouse mr-2"></i>คลังสินค้า</button>
            <button onclick="showPage('customers')" class="btn pastel-bg-pink"><i class="fas fa-users mr-2"></i>ข้อมูลลูกค้า</button>
            <button onclick="showPage('history')" class="btn pastel-bg-purple"><i class="fas fa-history mr-2"></i>ประวัติเอกสาร</button>
            <button onclick="showPage('settings')" class="btn pastel-bg-yellow"><i class="fas fa-cog mr-2"></i>ตั้งค่า</button>
        </nav>

        <!-- App Pages -->
        <main id="app-pages">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active-page text-center">
                 <div class="bg-white p-8 rounded-xl shadow-md max-w-3xl mx-auto">
                    <h2 class="text-3xl font-bold mb-2 text-gray-800">ยินดีต้อนรับ</h2>
                    <p class="text-gray-500 mb-8">เลือกรายการที่ต้องการทำจากด้านล่างได้เลยครับ</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onclick="openDocumentModal('quotation')" class="p-8 bg-blue-100 hover:bg-blue-200 rounded-lg shadow-lg text-2xl font-bold text-blue-800 transition duration-300 ease-in-out transform hover:-translate-y-1">
                            <i class="fas fa-file-invoice fa-2x mb-4"></i><br>สร้างใบเสนอราคา
                        </button>
                        <button onclick="openDocumentModal('receipt')" class="p-8 bg-green-100 hover:bg-green-200 rounded-lg shadow-lg text-2xl font-bold text-green-800 transition duration-300 ease-in-out transform hover:-translate-y-1">
                            <i class="fas fa-receipt fa-2x mb-4"></i><br>สร้างใบเสร็จ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Inventory Page -->
            <div id="inventory" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold">จัดการคลังสินค้า</h2>
                    <button onclick="openInventoryModal()" class="bg-green-500 text-white px-5 py-2 rounded-lg shadow hover:bg-green-600"><i class="fas fa-plus mr-2"></i>เพิ่มสินค้าใหม่</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="border-b-2">
                                <th class="p-3">รหัสสินค้า</th>
                                <th class="p-3">ชื่อสินค้า</th>
                                <th class="p-3">ราคา (บาท)</th>
                                <th class="p-3">จำนวนคงคลัง</th>
                                <th class="p-3">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body">
                            <!-- Product rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Customers Page -->
            <div id="customers" class="page">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold">จัดการข้อมูลลูกค้า</h2>
                    <button onclick="openCustomerModal()" class="bg-pink-500 text-white px-5 py-2 rounded-lg shadow hover:bg-pink-600"><i class="fas fa-user-plus mr-2"></i>เพิ่มลูกค้าใหม่</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                     <table class="w-full text-left min-w-[600px]">
                        <thead>
                            <tr class="border-b-2">
                                <th class="p-3">ชื่อลูกค้า</th>
                                <th class="p-3">ที่อยู่</th>
                                <th class="p-3">เบอร์โทร</th>
                                <th class="p-3">เลขผู้เสียภาษี</th>
                                <th class="p-3">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="customers-table-body">
                            <!-- Customer rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- History Page -->
            <div id="history" class="page">
                <h2 class="text-3xl font-bold mb-4">ประวัติเอกสาร</h2>
                 <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left min-w-[700px]">
                        <thead>
                            <tr class="border-b-2">
                                <th class="p-3">ประเภท</th>
                                <th class="p-3">เลขที่เอกสาร</th>
                                <th class="p-3">ชื่อลูกค้า</th>
                                <th class="p-3">วันที่</th>
                                <th class="p-3">ยอดรวม (บาท)</th>
                                <th class="p-3">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                           <!-- History rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings" class="page">
                <h2 class="text-3xl font-bold mb-4">ตั้งค่าข้อมูลบริษัท</h2>
                <div class="bg-white p-8 rounded-lg shadow-md">
                    <form id="settings-form" class="space-y-6">
                        <input type="text" id="company-name" placeholder="ชื่อบริษัท" class="w-full p-3 border rounded-lg" required>
                        <textarea id="company-address" placeholder="ที่อยู่บริษัท" class="w-full p-3 border rounded-lg" rows="3" required></textarea>
                        <input type="text" id="company-tax-id" placeholder="เลขประจำตัวผู้เสียภาษี" class="w-full p-3 border rounded-lg">
                        <input type="text" id="company-phone" placeholder="เบอร์โทรศัพท์" class="w-full p-3 border rounded-lg">
                        
                        <div>
                            <label class="font-bold block mb-2">โลโก้บริษัท (แนะนำขนาด กว้าง 200px):</label>
                            <input type="file" id="logo-upload" accept="image/png, image/jpeg" class="w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                            <div class="mt-4">
                                <p>ภาพตัวอย่าง:</p>
                                <img id="logo-preview" src="https://placehold.co/200x80/e2e8f0/e2e8f0?text=+" alt="Logo Preview" class="mt-2 h-20 border p-1 bg-gray-100">
                            </div>
                            <input type="hidden" id="company-logo-url">
                        </div>

                        <div class="border-t pt-6">
                            <label class="font-bold block mb-2">หัวกระดาษ (Letterhead) (ขนาดที่แนะนำ: กว้าง 2480px สำหรับ A4):</label>
                            <input type="file" id="letterhead-upload" accept="image/png, image/jpeg" class="w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                            <div class="mt-4">
                                <p>ภาพตัวอย่าง:</p>
                                <img id="letterhead-preview" src="https://placehold.co/800x200/e2e8f0/e2e8f0?text=+" alt="Letterhead Preview" class="mt-2 w-full border p-1 bg-gray-100">
                            </div>
                            <input type="hidden" id="company-letterhead-url">
                        </div>
                        
                        <button type="submit" class="bg-yellow-500 text-white px-6 py-3 rounded-lg shadow hover:bg-yellow-600 text-lg font-bold w-full md:w-auto">บันทึกข้อมูล</button>
                    </form>
                </div>
            </div>
        </main>

    </div>

    <!-- Modals -->
    <div id="inventory-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-4">
            <h3 id="inventory-modal-title" class="text-2xl font-bold mb-6">เพิ่ม/แก้ไขสินค้า</h3>
            <form id="inventory-form" class="space-y-4">
                <input type="hidden" id="inventory-id">
                <input type="text" id="product-code" placeholder="รหัสสินค้า (ถ้ามี)" class="w-full p-3 border rounded-lg">
                <input type="text" id="product-name" placeholder="ชื่อสินค้า*" class="w-full p-3 border rounded-lg" required>
                <input type="number" id="product-price" placeholder="ราคาต่อหน่วย*" class="w-full p-3 border rounded-lg" required min="0" step="0.01">
                <input type="number" id="product-quantity" placeholder="จำนวนคงคลัง*" class="w-full p-3 border rounded-lg" required min="0">
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeInventoryModal()" class="bg-gray-300 px-6 py-2 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="bg-green-500 text-white px-6 py-2 rounded-lg">บันทึก</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="customer-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-4">
             <h3 id="customer-modal-title" class="text-2xl font-bold mb-6">เพิ่ม/แก้ไขข้อมูลลูกค้า</h3>
            <form id="customer-form" class="space-y-4">
                <input type="hidden" id="customer-id">
                <input type="text" id="customer-name" placeholder="ชื่อลูกค้า*" class="w-full p-3 border rounded-lg" required>
                <textarea id="customer-address" placeholder="ที่อยู่*" class="w-full p-3 border rounded-lg" rows="3" required></textarea>
                <input type="text" id="customer-phone" placeholder="เบอร์โทร" class="w-full p-3 border rounded-lg">
                <input type="text" id="customer-tax-id" placeholder="เลขประจำตัวผู้เสียภาษี" class="w-full p-3 border rounded-lg">
                 <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeCustomerModal()" class="bg-gray-300 px-6 py-2 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="bg-pink-500 text-white px-6 py-2 rounded-lg">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <div id="document-modal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl mx-4">
            <h3 id="document-modal-title" class="text-2xl font-bold mb-6">สร้างเอกสาร</h3>
            <form id="document-form" class="space-y-4">
                <input type="hidden" id="document-type">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="font-bold">ลูกค้า:</label>
                        <select id="document-customer" class="w-full p-3 border rounded-lg" required></select>
                    </div>
                    <div>
                        <label class="font-bold">วันที่:</label>
                        <input type="date" id="document-date" class="w-full p-3 border rounded-lg" required>
                    </div>
                </div>
                
                <h4 class="text-xl font-bold mt-6 mb-2">รายการสินค้า</h4>
                <div id="document-items" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    <!-- Item rows will be added here -->
                </div>
                <button type="button" onclick="addDocumentItem()" class="bg-blue-500 text-white px-4 py-2 rounded-lg mt-2"><i class="fas fa-plus mr-2"></i>เพิ่มรายการ</button>

                <div class="text-right mt-6 space-y-2 text-xl">
                    <div>ราคารวม: <span id="subtotal">0.00</span> บาท</div>
                    <div>ภาษีมูลค่าเพิ่ม 7%: <span id="vat">0.00</span> บาท</div>
                    <div class="font-bold">ยอดรวมสุทธิ: <span id="grandtotal">0.00</span> บาท</div>
                </div>

                <div class="flex justify-end space-x-4 pt-6">
                    <button type="button" onclick="closeDocumentModal()" class="bg-gray-300 px-6 py-2 rounded-lg">ยกเลิก</button>
                    <button type="submit" class="bg-green-500 text-white px-6 py-2 rounded-lg">สร้างเอกสาร</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="print-area" class="hidden"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAl-4g75Azf820VWoSnUC_fZjPmPSFY7Kk",
            authDomain: "ptbiz-cf8f8.firebaseapp.com",
            projectId: "ptbiz-cf8f8",
            storageBucket: "ptbiz-cf8f8.appspot.com",
            messagingSenderId: "183705678378",
            appId: "1:183705678378:web:7182914636995d952c0953"
        };
        
        // --- PRE-FLIGHT CHECK ---
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("...")) {
            document.body.innerHTML = `<div class="h-screen w-screen flex flex-col justify-center items-center text-center p-4 bg-red-100 text-red-800"><h1 class="text-3xl font-bold mb-4">ข้อผิดพลาดในการตั้งค่า</h1><p class="text-lg">ไม่พบข้อมูลการตั้งค่า Firebase (Firebase Config)</p><p class="mt-4 text-md">กรุณาเปิดไฟล์ <code>index.html</code> แล้ววางข้อมูล <code>firebaseConfig</code> ของคุณตามขั้นตอนในคู่มือ</p></div>`;
            throw new Error("Firebase config is missing.");
        }

        const appId = 'default-business-tool-app';
        let app, auth, db, storage;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (error) {
             document.body.innerHTML = `<div class="h-screen w-screen flex flex-col justify-center items-center text-center p-4 bg-red-100 text-red-800"><h1 class="text-3xl font-bold mb-4">ข้อผิดพลาดในการเชื่อมต่อ Firebase</h1><p class="text-lg">เกิดข้อผิดพลาด: ${error.message}</p><p class="mt-4 text-md">โปรดตรวจสอบว่าข้อมูล <code>firebaseConfig</code> ของคุณถูกต้องหรือไม่</p></div>`;
            throw new Error("Firebase initialization failed: " + error.message);
        }
        
        let userId = null;
        let companyInfo = {};
        let inventoryCache = [];
        let customersCache = [];

        const provider = new GoogleAuthProvider();

        window.signInWithGoogle = () => {
            signInWithPopup(auth, provider).catch((error) => {
                console.error("Google Sign-In Error", error);
                alert('เกิดข้อผิดพลาดในการลงชื่อเข้าใช้ด้วย Google: ' + error.message);
            });
        }

        window.signOutUser = () => {
            signOut(auth).catch((error) => console.error("Sign Out Error", error));
        }

        onAuthStateChanged(auth, (user) => {
            const mainApp = document.getElementById('app-container');
            const body = document.body;
            const existingLoginScreen = document.getElementById('login-screen');
            if (existingLoginScreen) existingLoginScreen.remove();
        
            if (user) {
                userId = user.uid;
                mainApp.classList.remove('hidden');
                const authContainer = document.getElementById('auth-container');
                const userInfo = document.getElementById('user-info');
                authContainer.innerHTML = `<button onclick="signOutUser()" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow hover:bg-red-600">ออกจากระบบ</button>`;
                document.getElementById('user-display-name').textContent = user.displayName || 'ผู้ใช้';
                document.getElementById('user-email').textContent = user.email || '';
                userInfo.classList.remove('hidden');
        
                if (!body.dataset.appInitialized) {
                    initializeAppLogic();
                    body.dataset.appInitialized = 'true';
                }
            } else {
                userId = null;
                mainApp.classList.add('hidden');
                const loginScreen = document.createElement('div');
                loginScreen.id = 'login-screen';
                loginScreen.className = 'h-screen w-screen flex flex-col justify-center items-center text-center p-4 bg-gray-50';
                loginScreen.innerHTML = `<h1 class="text-4xl md:text-5xl font-bold text-gray-700 mb-2">ระบบจัดการธุรกิจ</h1><p class="text-lg text-gray-500 mb-8">กรุณาลงชื่อเข้าใช้เพื่อจัดการข้อมูลของคุณ</p><button onclick="signInWithGoogle()" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-blue-700 text-xl flex items-center transition transform hover:scale-105"><svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" /><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" /><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" /><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" /></svg> ลงชื่อเข้าใช้ด้วย Google</button>`;
                body.prepend(loginScreen);
                delete body.dataset.appInitialized;
            }
        });

        function initializeAppLogic() {
            if (!userId) return;
            setupListeners();
            setupUI();
            checkCompanySettings();
        }

        function getCollectionPath(collectionName) {
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }
        
        function setupListeners() {
            onSnapshot(doc(db, getCollectionPath('app_settings'), 'company_info'), (docSnap) => {
                if (docSnap.exists()) {
                    companyInfo = docSnap.data();
                    populateSettingsForm();
                }
            });

            onSnapshot(collection(db, getCollectionPath('inventory')), (snapshot) => {
                const tableBody = document.getElementById('inventory-table-body');
                tableBody.innerHTML = '';
                inventoryCache = [];
                snapshot.forEach(docSnap => {
                    const product = { id: docSnap.id, ...docSnap.data() };
                    inventoryCache.push(product);
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="p-3">${product.code || '-'}</td><td class="p-3 font-bold">${product.name}</td><td class="p-3">${parseFloat(product.price).toFixed(2)}</td><td class="p-3">${product.quantity}</td><td class="p-3 space-x-2"><button title="แก้ไข" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button><button title="ลบ" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>`;
                    row.querySelector('.fa-edit').parentElement.onclick = () => openInventoryModal(docSnap.id);
                    row.querySelector('.fa-trash').parentElement.onclick = () => deleteInventoryItem(docSnap.id);
                    tableBody.appendChild(row);
                });
            });
            
            onSnapshot(collection(db, getCollectionPath('customers')), (snapshot) => {
                const tableBody = document.getElementById('customers-table-body');
                tableBody.innerHTML = '';
                customersCache = [];
                snapshot.forEach(docSnap => {
                    const customer = { id: docSnap.id, ...docSnap.data() };
                    customersCache.push(customer);
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="p-3 font-bold">${customer.name}</td><td class="p-3">${customer.address}</td><td class="p-3">${customer.phone || '-'}</td><td class="p-3">${customer.taxId || '-'}</td><td class="p-3 space-x-2"><button title="แก้ไข" class="text-blue-500 hover:text-blue-700"><i class="fas fa-edit"></i></button><button title="ลบ" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>`;
                    row.querySelector('.fa-edit').parentElement.onclick = () => openCustomerModal(docSnap.id);
                    row.querySelector('.fa-trash').parentElement.onclick = () => deleteCustomer(docSnap.id);
                    tableBody.appendChild(row);
                });
            });

            onSnapshot(query(collection(db, getCollectionPath('documents'))), (snapshot) => {
                const tableBody = document.getElementById('history-table-body');
                tableBody.innerHTML = '';
                const docs = snapshot.docs.sort((a, b) => b.data().date.toMillis() - a.data().date.toMillis());
                
                docs.forEach(docSnap => {
                    const docData = docSnap.data();
                    const date = docData.date.toDate().toLocaleDateString('th-TH', { day: '2-digit', month: 'short', year: 'numeric' });
                    const row = document.createElement('tr');
                    
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'p-3 space-x-3';

                    const viewBtn = document.createElement('button');
                    viewBtn.innerHTML = 'ดู';
                    viewBtn.className = 'text-blue-500 hover:underline';
                    viewBtn.onclick = () => viewDocument(docSnap.id);
                    actionsCell.appendChild(viewBtn);

                    if (docData.type === 'quotation') {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = `<i class="fas fa-trash text-red-500 hover:text-red-700"></i>`;
                        deleteBtn.title = "ลบใบเสนอราคา";
                        deleteBtn.onclick = () => deleteDocument(docSnap.id);
                        actionsCell.appendChild(deleteBtn);
                    }

                    row.innerHTML = `<td class="p-3">${docData.type === 'quotation' ? 'ใบเสนอราคา' : 'ใบเสร็จ'}</td><td class="p-3">${docData.number}</td><td class="p-3">${docData.customer.name}</td><td class="p-3">${date}</td><td class="p-3 text-right">${parseFloat(docData.grandTotal).toFixed(2)}</td>`;
                    row.appendChild(actionsCell);
                    tableBody.appendChild(row);
                });
            });
        }
        
        window.showPage = (pageId) => {
            document.querySelectorAll('#app-pages .page').forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
        }

        function setupUI() {
            document.getElementById('logo-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('logo-preview').src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });
            document.getElementById('letterhead-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('letterhead-preview').src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('settings-form').addEventListener('submit', saveSettings);
            document.getElementById('inventory-form').addEventListener('submit', saveInventoryItem);
            document.getElementById('customer-form').addEventListener('submit', saveCustomer);
            document.getElementById('document-form').addEventListener('submit', saveDocument);
        }

        async function checkCompanySettings() {
            const docRef = doc(db, getCollectionPath('app_settings'), 'company_info');
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists() || !docSnap.data().name) {
                showPage('settings');
                alert('กรุณากรอกข้อมูลบริษัทของคุณเพื่อเริ่มใช้งาน');
            }
        }
        
        function populateSettingsForm() {
            if(companyInfo) {
                document.getElementById('company-name').value = companyInfo.name || '';
                document.getElementById('company-address').value = companyInfo.address || '';
                document.getElementById('company-tax-id').value = companyInfo.taxId || '';
                document.getElementById('company-phone').value = companyInfo.phone || '';
                document.getElementById('company-logo-url').value = companyInfo.logoUrl || '';
                document.getElementById('logo-preview').src = companyInfo.logoUrl || 'https://placehold.co/200x80/e2e8f0/e2e8f0?text=+';
                document.getElementById('company-letterhead-url').value = companyInfo.letterheadUrl || '';
                document.getElementById('letterhead-preview').src = companyInfo.letterheadUrl || 'https://placehold.co/800x200/e2e8f0/e2e8f0?text=+';
            }
        }
        
        async function saveSettings(e) {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';

            try {
                let logoUrl = document.getElementById('company-logo-url').value;
                const logoFile = document.getElementById('logo-upload').files[0];
                if (logoFile) {
                    const logoStorageRef = ref(storage, `logos/${userId}/${logoFile.name}`);
                    await uploadBytes(logoStorageRef, logoFile);
                    logoUrl = await getDownloadURL(logoStorageRef);
                }

                let letterheadUrl = document.getElementById('company-letterhead-url').value;
                const letterheadFile = document.getElementById('letterhead-upload').files[0];
                if (letterheadFile) {
                    const letterheadStorageRef = ref(storage, `letterheads/${userId}/${letterheadFile.name}`);
                    await uploadBytes(letterheadStorageRef, letterheadFile);
                    letterheadUrl = await getDownloadURL(letterheadStorageRef);
                }
                
                const settingsData = {
                    name: document.getElementById('company-name').value.trim(),
                    address: document.getElementById('company-address').value.trim(),
                    taxId: document.getElementById('company-tax-id').value.trim(),
                    phone: document.getElementById('company-phone').value.trim(),
                    logoUrl: logoUrl,
                    letterheadUrl: letterheadUrl
                };
                if (!settingsData.name || !settingsData.address) {
                    throw new Error('กรุณากรอกชื่อและที่อยู่บริษัท');
                }
                
                await setDoc(doc(db, getCollectionPath('app_settings'), 'company_info'), settingsData, { merge: true });
                alert('บันทึกข้อมูลบริษัทสำเร็จแล้ว');
                showPage('dashboard');

            } catch(error) {
                console.error("Error saving settings:", error);
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูลตั้งค่า: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกข้อมูล';
            }
        }

        window.openInventoryModal = (id = null) => {
            document.getElementById('inventory-form').reset();
            document.getElementById('inventory-id').value = '';
             if (id) {
                document.getElementById('inventory-modal-title').textContent = 'แก้ไขสินค้า';
                const product = inventoryCache.find(p => p.id === id);
                if (product) {
                    document.getElementById('inventory-id').value = product.id;
                    document.getElementById('product-code').value = product.code || '';
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-quantity').value = product.quantity;
                }
            } else {
                 document.getElementById('inventory-modal-title').textContent = 'เพิ่มสินค้าใหม่';
            }
            document.getElementById('inventory-modal').classList.remove('hidden');
        }

        window.closeInventoryModal = () => document.getElementById('inventory-modal').classList.add('hidden');

        async function saveInventoryItem(e) {
            e.preventDefault();
            const name = document.getElementById('product-name').value.trim();
            const priceStr = document.getElementById('product-price').value;
            const quantityStr = document.getElementById('product-quantity').value;
            if (!name || !priceStr || !quantityStr) {
                alert('กรุณากรอกข้อมูลสินค้าให้ครบถ้วน (ชื่อ, ราคา, จำนวน)');
                return;
            }
            const price = parseFloat(priceStr);
            const quantity = parseInt(quantityStr);
            if (isNaN(price) || isNaN(quantity) || price < 0 || quantity < 0) {
                alert('กรุณากรอกราคาและจำนวนให้เป็นตัวเลขที่ถูกต้อง');
                return;
            }
            const id = document.getElementById('inventory-id').value;
            const data = { code: document.getElementById('product-code').value.trim(), name, price, quantity };
            try {
                if (id) {
                    await updateDoc(doc(db, getCollectionPath('inventory'), id), data);
                } else {
                    await addDoc(collection(db, getCollectionPath('inventory')), data);
                }
                closeInventoryModal();
                alert('บันทึกข้อมูลสินค้าสำเร็จ');
            } catch (error) {
                console.error("Error saving inventory item: ", error);
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + error.message);
            }
        }
        
        window.deleteInventoryItem = async (id) => {
             if (confirm('คุณต้องการลบสินค้านี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                try {
                    await deleteDoc(doc(db, getCollectionPath('inventory'), id));
                    alert('ลบสินค้าสำเร็จ');
                } catch (error) {
                    console.error("Error deleting item:", error);
                    alert("เกิดข้อผิดพลาดในการลบสินค้า: " + error.message);
                }
            }
        }
        
        window.openCustomerModal = (id = null) => {
            document.getElementById('customer-form').reset();
            document.getElementById('customer-id').value = '';
            if (id) {
                document.getElementById('customer-modal-title').textContent = 'แก้ไขข้อมูลลูกค้า';
                const customer = customersCache.find(c => c.id === id);
                if (customer) {
                    document.getElementById('customer-id').value = customer.id;
                    document.getElementById('customer-name').value = customer.name;
                    document.getElementById('customer-address').value = customer.address;
                    document.getElementById('customer-phone').value = customer.phone || '';
                    document.getElementById('customer-tax-id').value = customer.taxId || '';
                }
            } else {
                document.getElementById('customer-modal-title').textContent = 'เพิ่มลูกค้าใหม่';
            }
            document.getElementById('customer-modal').classList.remove('hidden');
        }

        window.closeCustomerModal = () => document.getElementById('customer-modal').classList.add('hidden');

        async function saveCustomer(e) {
            e.preventDefault();
            const id = document.getElementById('customer-id').value;
            const data = { name: document.getElementById('customer-name').value.trim(), address: document.getElementById('customer-address').value.trim(), phone: document.getElementById('customer-phone').value.trim(), taxId: document.getElementById('customer-tax-id').value.trim() };
            if (!data.name || !data.address) {
                alert('กรุณากรอกชื่อและที่อยู่ของลูกค้า');
                return;
            }
            try {
                if (id) {
                    await updateDoc(doc(db, getCollectionPath('customers'), id), data);
                } else {
                    await addDoc(collection(db, getCollectionPath('customers')), data);
                }
                closeCustomerModal();
                alert('บันทึกข้อมูลลูกค้าสำเร็จ');
            } catch (error) {
                console.error("Error saving customer:", error);
                alert('เกิดข้อผิดพลาดในการบันทึกข้อมูลลูกค้า: ' + error.message);
            }
        }

        window.deleteCustomer = async (id) => {
            if (confirm('คุณต้องการลบข้อมูลลูกค้านี้ใช่หรือไม่?')) {
                try {
                    await deleteDoc(doc(db, getCollectionPath('customers'), id));
                    alert('ลบข้อมูลลูกค้าสำเร็จ');
                } catch (error) {
                    console.error("Error deleting customer:", error);
                    alert("เกิดข้อผิดพลาดในการลบข้อมูลลูกค้า: " + error.message);
                }
            }
        }
        
        window.deleteDocument = async (id) => {
             if (confirm('คุณต้องการลบใบเสนอราคานี้ใช่หรือไม่?')) {
                try {
                    await deleteDoc(doc(db, getCollectionPath('documents'), id));
                    alert('ลบใบเสนอราคาสำเร็จ');
                } catch (error) {
                    console.error("Error deleting document:", error);
                    alert("เกิดข้อผิดพลาดในการลบเอกสาร: " + error.message);
                }
            }
        }

        window.openDocumentModal = (type) => {
            const form = document.getElementById('document-form');
            form.reset();
            document.getElementById('document-type').value = type;
            document.getElementById('document-modal-title').innerText = type === 'quotation' ? 'สร้างใบเสนอราคา' : 'สร้างใบเสร็จ';
            document.getElementById('document-date').valueAsDate = new Date();
            const customerSelect = document.getElementById('document-customer');
            customerSelect.innerHTML = '<option value="">-- เลือกลูกค้า --</option>';
            customersCache.forEach(c => customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            document.getElementById('document-items').innerHTML = '';
            addDocumentItem();
            updateTotals();
            document.getElementById('document-modal').classList.remove('hidden');
        }

        window.closeDocumentModal = () => document.getElementById('document-modal').classList.add('hidden');

        let itemCounter = 0;
        window.addDocumentItem = () => {
            itemCounter++;
            const itemRow = document.createElement('div');
            itemRow.className = 'grid grid-cols-12 gap-2 items-center';
            itemRow.id = `item-row-${itemCounter}`;
            let productOptions = '<option value="">-- เลือกสินค้า --</option>';
            inventoryCache.forEach(p => productOptions += `<option value="${p.id}" data-price="${p.price}">${p.name} (คงเหลือ: ${p.quantity})</option>`);
            itemRow.innerHTML = `<div class="col-span-6"><select class="item-product w-full p-2 border rounded">${productOptions}</select></div><div class="col-span-2"><input type="number" class="item-quantity w-full p-2 border rounded" placeholder="จำนวน" min="1" value="1"></div><div class="col-span-3 text-right"><span class="item-total p-2">0.00</span></div><div class="col-span-1 text-right"><button type="button" class="text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button></div>`;
            itemRow.querySelector('.item-product').onchange = () => updateItemPrice(itemRow.querySelector('.item-product'));
            itemRow.querySelector('.item-quantity').oninput = () => updateTotals();
            itemRow.querySelector('button').onclick = () => removeDocumentItem(`item-row-${itemCounter}`);
            document.getElementById('document-items').appendChild(itemRow);
        }

        window.removeDocumentItem = (rowId) => {
            document.getElementById(rowId).remove();
            updateTotals();
        }

        window.updateItemPrice = (selectElement) => {
            selectElement.closest('.grid').querySelector('.item-quantity').value = 1;
            updateTotals();
        }

        window.updateTotals = () => {
            let subtotal = 0;
            document.querySelectorAll('#document-items .grid').forEach(row => {
                const productSelect = row.querySelector('.item-product');
                if (!productSelect.value) return;
                const selectedOption = productSelect.options[productSelect.selectedIndex];
                const price = parseFloat(selectedOption.dataset.price) || 0;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const itemTotal = price * quantity;
                row.querySelector('.item-total').innerText = itemTotal.toFixed(2);
                subtotal += itemTotal;
            });
            const vat = subtotal * 0.07;
            const grandTotal = subtotal + vat;
            document.getElementById('subtotal').innerText = subtotal.toFixed(2);
            document.getElementById('vat').innerText = vat.toFixed(2);
            document.getElementById('grandtotal').innerText = grandTotal.toFixed(2);
        }

        async function saveDocument(e) {
            e.preventDefault();
            try {
                const docType = document.getElementById('document-type').value;
                const customerId = document.getElementById('document-customer').value;
                if (!customerId) throw new Error('กรุณาเลือกลูกค้า');
                const customer = customersCache.find(c => c.id === customerId);

                const items = [];
                let hasInvalidItem = false;
                document.querySelectorAll('#document-items .grid').forEach(row => {
                    if (hasInvalidItem) return;
                    const productId = row.querySelector('.item-product').value;
                    const quantity = parseInt(row.querySelector('.item-quantity').value);
                    if (!productId || !quantity || quantity <= 0) {
                        hasInvalidItem = true; return;
                    }
                    const product = inventoryCache.find(p => p.id === productId);
                    if (docType === 'receipt' && quantity > product.quantity) {
                        throw new Error(`สินค้า '${product.name}' มีไม่พอ (คงเหลือ ${product.quantity})`);
                    }
                    items.push({ productId, name: product.name, code: product.code, quantity, price: product.price, total: product.price * quantity });
                });
                if (hasInvalidItem || items.length === 0) throw new Error('กรุณาตรวจสอบรายการสินค้าให้ถูกต้อง');
                
                let newDocNumber = '';
                const settingsRef = doc(db, getCollectionPath('app_settings'), 'company_info');
                await runTransaction(db, async (transaction) => {
                    const settingsDoc = await transaction.get(settingsRef);
                    if (!settingsDoc.exists()) throw new Error("ไม่พบข้อมูลการตั้งค่าบริษัท");
                    const settingsData = settingsDoc.data();
                    if (docType === 'quotation') {
                        const lastNumber = settingsData.lastQuoteNumber || 0;
                        newDocNumber = `QT-${String(lastNumber + 1).padStart(6, '0')}`;
                        transaction.update(settingsRef, { lastQuoteNumber: lastNumber + 1 });
                    } else {
                        const lastNumber = settingsData.lastReceiptNumber || 0;
                        newDocNumber = `INV-${String(lastNumber + 1).padStart(6, '0')}`;
                        transaction.update(settingsRef, { lastReceiptNumber: lastNumber + 1 });
                    }
                    if (docType === 'receipt') {
                        for (const item of items) {
                            const productRef = doc(db, getCollectionPath('inventory'), item.productId);
                            const productDoc = await transaction.get(productRef);
                            if (!productDoc.exists()) throw new Error(`ไม่พบสินค้า ${item.name} ในคลัง`);
                            const newQuantity = productDoc.data().quantity - item.quantity;
                            transaction.update(productRef, { quantity: newQuantity });
                        }
                    }
                });
                const docData = { number: newDocNumber, type: docType, date: new Date(document.getElementById('document-date').value), customer: { id: customer.id, name: customer.name, address: customer.address, taxId: customer.taxId }, items, subtotal: parseFloat(document.getElementById('subtotal').innerText), vat: parseFloat(document.getElementById('vat').innerText), grandTotal: parseFloat(document.getElementById('grandtotal').innerText), companyInfo };
                const newDocRef = await addDoc(collection(db, getCollectionPath('documents')), docData);
                if (docType === 'receipt') await addDoc(collection(db, getCollectionPath('revenue')), { date: docData.date, amount: docData.grandTotal, documentId: newDocRef.id, documentNumber: docData.number });
                alert(`สร้าง ${docType === 'quotation' ? 'ใบเสนอราคา' : 'ใบเสร็จ'} เลขที่ ${newDocNumber} สำเร็จ`);
                closeDocumentModal();
                viewDocument(newDocRef.id);
            } catch (error) {
                console.error("Failed to save document: ", error);
                alert("เกิดข้อผิดพลาดในการสร้างเอกสาร: " + error.message);
            }
        }
        
        window.viewDocument = async (docId) => {
            try {
                const docRef = doc(db, getCollectionPath('documents'), docId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error('ไม่พบเอกสาร');

                const data = docSnap.data();
                const printArea = document.getElementById('print-area');
                let itemsHtml = '';
                data.items.forEach(item => itemsHtml += `<tr class="border-b"><td class="p-2">${item.name}</td><td class="p-2 text-center">${item.quantity}</td><td class="p-2 text-right">${parseFloat(item.price).toFixed(2)}</td><td class="p-2 text-right">${parseFloat(item.total).toFixed(2)}</td></tr>`);
                const bahttext = (num) => { num = Number(num.toFixed(2)); let baht = Math.floor(num); let satang = Math.round((num - baht) * 100); if (satang === 0) return `(${read(baht)}บาทถ้วน)`; return `(${read(baht)}บาท${read(satang)}สตางค์)`; };
                const read = (num) => { const pos = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"], digit = ["", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า", "หก", "เจ็ด", "แปด", "เก้า"]; let out = "", n = String(num).split("").reverse().join(""); for (let i = 0; i < n.length; i++) { let str = "", d = Number(n[i]); if (d !== 0) { if (i === 0 && d === 1 && n.length > 1) str = "เอ็ด"; else if (i === 1 && d === 1) str = ""; else if (i === 1 && d === 2) str = "ยี่"; else str = digit[d]; str += pos[i]; } out = str + out; } return out; };

                printArea.innerHTML = `<div class="bg-white p-8" style="width: 210mm; min-height: 297mm; margin: auto;"> ${data.companyInfo.letterheadUrl ? `<img src="${data.companyInfo.letterheadUrl}" alt="Letterhead" class="w-full" onerror="this.style.display='none'">` : ''}<div class="no-print mb-4 flex justify-end space-x-2"><button onclick="window.print()" class="bg-blue-500 text-white px-4 py-2 rounded">พิมพ์</button><button onclick="closePrintView()" class="bg-gray-500 text-white px-4 py-2 rounded">ปิด</button></div><header class="flex justify-between items-start my-8 border-b-2 pb-4"><div>${data.companyInfo.logoUrl ? `<img src="${data.companyInfo.logoUrl}" alt="logo" class="h-20 mb-4" onerror="this.style.display='none'">` : ''}<h2 class="text-xl font-bold">${data.companyInfo.name}</h2><p class="text-sm" style="white-space: pre-wrap;">${data.companyInfo.address}</p><p class="text-sm">โทร: ${data.companyInfo.phone}</p><p class="text-sm">เลขประจำตัวผู้เสียภาษี: ${data.companyInfo.taxId}</p></div><div class="text-right flex-shrink-0"><h1 class="text-2xl font-bold mb-2">${data.type === 'quotation' ? 'ใบเสนอราคา / QUOTATION' : 'ใบกำกับภาษี / ใบเสร็จรับเงิน'}</h1><p>เลขที่/No.: ${data.number}</p><p>วันที่/Date: ${data.date.toDate().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</p></div></header><section class="border rounded-lg p-4 mb-8"><h3 class="font-bold">ข้อมูลลูกค้า</h3><p>${data.customer.name}</p><p style="white-space: pre-wrap;">ที่อยู่: ${data.customer.address}</p><p>เลขประจำตัวผู้เสียภาษี: ${data.customer.taxId || '-'}</p></section><table class="w-full mb-8 text-sm"><thead><tr class="border-b-2 border-black bg-gray-100"><th class="p-2 text-left">รายการ (Description)</th><th class="p-2 text-center" style="width:15%">จำนวน (Quantity)</th><th class="p-2 text-right" style="width:20%">ราคา/หน่วย (Unit Price)</th><th class="p-2 text-right" style="width:20%">รวมเงิน (Amount)</th></tr></thead><tbody>${itemsHtml}</tbody></table><footer class="flex justify-between items-start pt-4"><div class="w-1/2 text-sm"><p>ได้รับสินค้าตามรายการถูกต้องเรียบร้อยแล้ว</p><div class="mt-20">ผู้รับสินค้า (Receiver)</div><div class="mt-4">วันที่ (Date) _____/_____/______</div></div><div class="w-1/2"><table class="w-full text-sm"><tbody><tr><td class="p-2">รวมเป็นเงิน (Subtotal)</td><td class="p-2 text-right">${data.subtotal.toFixed(2)}</td></tr><tr><td class="p-2">ภาษีมูลค่าเพิ่ม 7% (VAT 7%)</td><td class="p-2 text-right">${data.vat.toFixed(2)}</td></tr><tr class="font-bold border-t-2 border-b-2 border-black text-lg"><td class="p-2">ยอดรวมสุทธิ (Grand Total)</td><td class="p-2 text-right">${data.grandTotal.toFixed(2)}</td></tr></tbody></table><div class="font-bold mt-2 text-center bg-gray-100 p-2 rounded-lg">${bahttext(data.grandTotal)}</div></div></footer></div>`;
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('print-area').classList.remove('hidden');
            } catch(error) {
                console.error("Error viewing document:", error);
                alert("เกิดข้อผิดพลาดในการแสดงเอกสาร: " + error.message);
            }
        }
        
        window.closePrintView = () => {
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';
            printArea.classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
        }
        
    </script>
</body>
</html>
